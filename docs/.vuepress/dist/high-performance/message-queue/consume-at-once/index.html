<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å®ç°Kafkaè‡³å°‘æˆåŠŸæ¶ˆè´¹ä¸€æ¬¡ | LearnWord</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="ä¸“æ³¨æŠ€æœ¯åˆ†äº«ï¼Œä»åç«¯å…«è‚¡åˆ°å®è·µ">
    
    <link rel="preload" href="/LearingWord/assets/css/0.styles.8ee1b52f.css" as="style"><link rel="preload" href="/LearingWord/assets/js/app.352ff452.js" as="script"><link rel="preload" href="/LearingWord/assets/js/2.a91a21bc.js" as="script"><link rel="preload" href="/LearingWord/assets/js/6.9f44c348.js" as="script"><link rel="prefetch" href="/LearingWord/assets/js/10.8ba1676f.js"><link rel="prefetch" href="/LearingWord/assets/js/11.e02b8512.js"><link rel="prefetch" href="/LearingWord/assets/js/12.38e44c72.js"><link rel="prefetch" href="/LearingWord/assets/js/3.a5dff05d.js"><link rel="prefetch" href="/LearingWord/assets/js/4.acaee825.js"><link rel="prefetch" href="/LearingWord/assets/js/5.b66c11d1.js"><link rel="prefetch" href="/LearingWord/assets/js/7.69bf0675.js"><link rel="prefetch" href="/LearingWord/assets/js/8.046c8596.js"><link rel="prefetch" href="/LearingWord/assets/js/9.93a42852.js">
    <link rel="stylesheet" href="/LearingWord/assets/css/0.styles.8ee1b52f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open no-sidebar have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/LearingWord/" class="home-link router-link-active"><!----> <span class="site-name">LearnWord</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/LearingWord/" class="nav-link">ä¸»é¡µ</a></div><div class="nav-item"><a href="/LearingWord/categories/" class="nav-link">åˆ†ç±»</a></div><div class="nav-item"><a href="/LearingWord/home.html" class="nav-link">LearnWord</a></div><div class="nav-item"><a href="/LearingWord/books/" class="nav-link">æ¨èä¹¦ç±</a></div><div class="nav-item"><a href="/LearingWord/wechat-official-accounts/" class="nav-link">å…¬ä¼—å·</a></div><div class="nav-item"><a href="/LearingWord/about/" class="nav-link">å…³äº</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/LearingWord/" class="nav-link">ä¸»é¡µ</a></div><div class="nav-item"><a href="/LearingWord/categories/" class="nav-link">åˆ†ç±»</a></div><div class="nav-item"><a href="/LearingWord/home.html" class="nav-link">LearnWord</a></div><div class="nav-item"><a href="/LearingWord/books/" class="nav-link">æ¨èä¹¦ç±</a></div><div class="nav-item"><a href="/LearingWord/wechat-official-accounts/" class="nav-link">å…¬ä¼—å·</a></div><div class="nav-item"><a href="/LearingWord/about/" class="nav-link">å…³äº</a></div> <!----></nav>  <!----> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/LearingWord/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/LearingWord/categories/?category=high-performance" title="åˆ†ç±»" data-v-06225672>high-performance</a></li><li data-v-06225672><a href="/LearingWord/categories/?category=message-queue" title="åˆ†ç±»" data-v-06225672>message-queue</a></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>sky</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-12-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">å®ç°Kafkaè‡³å°‘æˆåŠŸæ¶ˆè´¹ä¸€æ¬¡<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="å®ç°kafkaè‡³å°‘æ¶ˆè´¹ä¸€æ¬¡"><a href="#å®ç°kafkaè‡³å°‘æ¶ˆè´¹ä¸€æ¬¡" class="header-anchor">#</a> å®ç°Kafkaè‡³å°‘æ¶ˆè´¹ä¸€æ¬¡</h1> <blockquote><p>åœ¨å®é™…é‡è¦çš„åœºæ™¯ä¸­ï¼Œå¸¸å¸¸éœ€è¦å®ç°æ¶ˆè´¹è€…è‡³å°‘æ¶ˆè´¹ä¸€æ¬¡ã€‚å› ä¸ºä½¿ç”¨é»˜è®¤çš„kafkaæ¶ˆè´¹è€…å­˜åœ¨æŸäº›é—®é¢˜ã€‚</p></blockquote> <h2 id="é»˜è®¤çš„kafkaæ¶ˆè´¹è€…å­˜åœ¨ä»€ä¹ˆé—®é¢˜"><a href="#é»˜è®¤çš„kafkaæ¶ˆè´¹è€…å­˜åœ¨ä»€ä¹ˆé—®é¢˜" class="header-anchor">#</a> é»˜è®¤çš„kafkaæ¶ˆè´¹è€…å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h2> <p>ï¼ˆ1ï¼‰éœ€è¦è‡ªå·±å®ç°é‡æ–°æ¶ˆè´¹æ•°æ®</p> <blockquote><p>åœ¨åˆšå¼€å§‹æ€è€ƒæ—¶ï¼Œæœ‰äººè®¤ä¸ºå®ç°é‡å¤æ¶ˆè´¹è¿˜ä¸ç®€å•ï¼Ÿå–æ¶ˆè‡ªåŠ¨æäº¤ï¼Œç¡®è®¤ä¸€æ‰¹æ¶ˆæ¯å·²ç»æ¶ˆè´¹æˆåŠŸå°±æ‰§è¡Œæ‰‹åŠ¨æäº¤ï¼Œå¦åˆ™ä¸æäº¤ï¼›ä¹‹åé‡æ–°è·å–æœªæäº¤çš„æ•°æ®ï¼Œå°±å¯ä»¥è¾¾åˆ°é‡å¤æ¶ˆè´¹çš„ç›®çš„ã€‚</p> <p>å¯æ˜¯ï¼Œäº‹å®æ˜¯æ®‹é…·çš„ï¼Œè¯•ä¸€æ¬¡å°±çŸ¥é“ï¼Œæ„Ÿè§‰æ‰‹åŠ¨ä¸æäº¤æ²¡æœ‰ç”¨ä¸€æ ·ğŸ˜‚ï¼Œæ¶ˆè´¹è€…ä¸€ç›´åœ¨å¾€åæ¶ˆè´¹ã€‚</p></blockquote> <p>å¯¹äºKafkaä¸­çš„åˆ†åŒºè€Œè¨€ï¼Œå®ƒçš„æ¯æ¡æ¶ˆæ¯éƒ½æœ‰å”¯ä¸€çš„ offset ï¼Œç”¨æ¥è¡¨ç¤ºæ¶ˆæ¯åœ¨åˆ†åŒºä¸­å¯¹åº”çš„ä½ç½®ï¼ˆcalledï¼šåç§»é‡ï¼‰ã€‚ å¯¹äºæ¶ˆè´¹è€…è€Œè¨€ï¼Œå®ƒä¹Ÿæœ‰ä¸€ä¸ª offset çš„æ¦‚å¿µï¼Œæ¶ˆè´¹è€…ä½¿ç”¨offsetæ¥è¡¨ç¤ºæ¶ˆè´¹åˆ°åˆ†åŒºä¸­æŸä¸ªæ¶ˆæ¯æ‰€åœ¨çš„ä½ç½®ï¼ˆcalledï¼šä½ç§»ï¼‰ã€‚åç§»é‡å­˜å‚¨åœ¨Kafkaå†…éƒ¨çš„ä¸»é¢˜ __consumer_offsets ä¸­ï¼Œè€Œä½ç§»å­˜å‚¨åœ¨æ¶ˆè´¹è€…ç«¯çš„å†…å­˜ä¸­ã€‚â€œæäº¤â€å°±æ˜¯å°†æ¶ˆè´¹è€…ç«¯å­˜å‚¨çš„ä½ç§»å­˜å‚¨åˆ° __consumer_offsets æŒä¹…åŒ–ï¼Œå½“æ¶ˆè´¹è€…å‘ç”Ÿå´©æºƒæˆ–å‘ç”Ÿæ¶ˆè´¹è€…é‡å¹³è¡¡æ—¶ï¼Œå°±ä¼šå»è¯»å–å­˜å‚¨åœ¨ __consumer_offsets ä¸­çš„åç§»é‡ï¼Œå…¶ä»–æ­£å¸¸æƒ…å†µä¸‹éƒ½æ˜¯æŒ‰å†…å­˜å­˜å‚¨çš„ä½ç§»åœ¨é¡ºåºè¯»å–ã€‚å› æ­¤ï¼ŒæŒ‰ç…§ä¸Šè¿°æ“ä½œå°±ä¼šå‡ºç°æäº¤æ²¡ç”¨çš„æ•ˆæœã€‚</p> <p>ï¼ˆ2ï¼‰è‡ªåŠ¨æäº¤æƒ…å†µä¸‹ï¼Œå¯èƒ½å‡ºç°æ¶ˆæ¯ä¸¢å¤±æƒ…å†µ
æ‹‰å–çº¿ç¨‹ A ä¸æ–­åœ°æ‹‰å–æ¶ˆæ¯å¹¶å­˜å…¥æœ¬åœ°ç¼“å­˜ï¼Œæ¯”å¦‚åœ¨ BlockingQueue ä¸­ï¼Œå¦ä¸€ä¸ªå¤„ç†çº¿ç¨‹ B ä»ç¼“å­˜ä¸­è¯»å–æ¶ˆæ¯å¹¶è¿›è¡Œç›¸åº”çš„é€»è¾‘å¤„ç†ã€‚å‡è®¾ç›®å‰è¿›è¡Œåˆ°äº†ç¬¬ y+1 æ¬¡æ‹‰å–ï¼Œä»¥åŠç¬¬ m æ¬¡ä½ç§»æäº¤çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯ x+6 ä¹‹å‰çš„ä½ç§»å·±ç»ç¡®è®¤æäº¤äº†ï¼Œå¤„ç†çº¿ç¨‹ B å´è¿˜æ­£åœ¨æ¶ˆè´¹ x+3 çš„æ¶ˆæ¯ ã€‚ æ­¤æ—¶å¦‚æœå¤„ç†çº¿ç¨‹B å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¾…å…¶æ¢å¤ä¹‹åä¼šä»ç¬¬ m æ¬¡ä½ç§»æäº¤å¤„ï¼Œä¹Ÿå°±æ˜¯ x+6 çš„ä½ç½®å¼€å§‹æ‹‰å–æ¶ˆæ¯ï¼Œé‚£ä¹ˆ x+3 è‡³ x+6 ä¹‹é—´çš„æ¶ˆæ¯å°±æ²¡æœ‰å¾—åˆ°ç›¸åº”çš„å¤„ç†ï¼Œè¿™æ ·ä¾¿å‘ç”Ÿæ¶ˆæ¯ä¸¢å¤±çš„ç°è±¡ ã€‚</p> <p><img src="/LearingWord/assets/img/kafka-msg-drop.35d6fca2.png" alt="kafka-msg-drop.png"></p> <h2 id="å®ç°è‡³å°‘æ¶ˆè´¹ä¸€æ¬¡"><a href="#å®ç°è‡³å°‘æ¶ˆè´¹ä¸€æ¬¡" class="header-anchor">#</a> å®ç°è‡³å°‘æ¶ˆè´¹ä¸€æ¬¡</h2> <blockquote><p>è¯­è¨€ï¼špython 3.8
å·¥å…·ï¼šconfluent-kafka</p></blockquote> <p>ç›®å‰æœ‰2ä¸ªæ€è·¯ï¼Œç¬¬1ä¸ªæ—¶æ–°å»ºä¸€ä¸ªé‡è¯•é˜Ÿåˆ—ï¼Œå½“é‡åˆ°é—®é¢˜æ¶ˆæ¯æ—¶å°†å…¶æ’å…¥åˆ°é‡è¯•é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…å¯ä»¥å†æ¬¡è·å–åˆ°è¯¥é—®é¢˜æ¶ˆæ¯å¹¶å†æ¬¡æ¶ˆè´¹ã€‚ç¬¬2ä¸ªæ˜¯é€šè¿‡ seek æ–¹æ³•è®¾ç½®ä½ç§»åˆ°æŒ‡å®šå‘ç”Ÿé—®é¢˜çš„ä½ç½®ï¼Œä½¿å¾—é‡æ–°æ¶ˆè´¹é—®é¢˜æ¶ˆæ¯ï¼›</p> <h3 id="åŠ å…¥é‡è¯•é˜Ÿåˆ—å†æ¬¡æ¶ˆè´¹"><a href="#åŠ å…¥é‡è¯•é˜Ÿåˆ—å†æ¬¡æ¶ˆè´¹" class="header-anchor">#</a> åŠ å…¥é‡è¯•é˜Ÿåˆ—å†æ¬¡æ¶ˆè´¹</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">KafkaAtLeastOnceConsumer</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    æ³¨æ„ï¼š
    1. ç”¨æˆ·æ–¹æ³•é¡»è¿”å›Booleanç±»å‹æ•°æ®ï¼ŒFalseå°†å¯èƒ½é‡æ–°æ¶ˆè´¹è¯¥æ•°æ®
    2. ç”¨æˆ·æ¶ˆæ¯å†…å®¹ä¸å¾—åŒ…å« try_countã€old_topic å…³é”®å­—

    &quot;&quot;&quot;</span>

    run_flag <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">if</span> config<span class="token punctuation">.</span>DEBUG<span class="token punctuation">:</span>
        total_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
            self<span class="token punctuation">,</span>
            group_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
            topic_list<span class="token punctuation">:</span> List<span class="token punctuation">,</span>
            user_function<span class="token punctuation">:</span> Callable<span class="token punctuation">,</span>
            servers<span class="token punctuation">:</span> List <span class="token operator">=</span> config<span class="token punctuation">.</span>KAFKA_HOST<span class="token punctuation">,</span>
            consumer_count<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
            reset_type<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">'latest'</span><span class="token punctuation">,</span>
            concurrency<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
            batch_size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">,</span>
            timeout<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
            base_mode<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
            retry_count<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> consumer_count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'æ¶ˆè´¹è€…æ•°ç›®é¡»å¤§äº0'</span>
        <span class="token keyword">assert</span> concurrency <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'æ¶ˆè´¹è€…å¹¶å‘åº¦é¡»å¤§äº0'</span>
        <span class="token keyword">assert</span> batch_size <span class="token operator">&gt;</span> concurrency<span class="token punctuation">,</span> <span class="token string">'å•æ‰¹æ¶ˆæ¯æ•°é¡»å¤§äºå¹¶å‘åº¦'</span>
        <span class="token keyword">assert</span> timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'è·å–æ¶ˆæ¯è¶…æ—¶æ—¶é—´é¡»å¤§äº0'</span>
        <span class="token keyword">assert</span> retry_count <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'é‡è¯•æ¬¡æ•°åº”å¤§äºç­‰äº-1'</span>

        self<span class="token punctuation">.</span>_consumer_count <span class="token operator">=</span> consumer_count
        self<span class="token punctuation">.</span>_pool <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>self<span class="token punctuation">.</span>_consumer_count<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_servers <span class="token operator">=</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>servers<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_group_id <span class="token operator">=</span> group_id
        self<span class="token punctuation">.</span>_user_function <span class="token operator">=</span> user_function
        self<span class="token punctuation">.</span>_reset_type <span class="token operator">=</span> reset_type
        self<span class="token punctuation">.</span>_topic_list <span class="token operator">=</span> topic_list
        self<span class="token punctuation">.</span>_concurrency <span class="token operator">=</span> concurrency
        self<span class="token punctuation">.</span>_batch_size <span class="token operator">=</span> batch_size
        self<span class="token punctuation">.</span>_timeout <span class="token operator">=</span> timeout
        self<span class="token punctuation">.</span>_retry_count <span class="token operator">=</span> retry_count

        self<span class="token punctuation">.</span>_process_num_per_thread <span class="token operator">=</span> <span class="token number">100</span>
        self<span class="token punctuation">.</span>_retry_topic_name <span class="token operator">=</span> <span class="token string">'kfk_retry_queue'</span>
        self<span class="token punctuation">.</span>_inner_producer <span class="token operator">=</span> <span class="token boolean">None</span>

        self<span class="token punctuation">.</span>_topic_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_retry_topic_name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> base_mode<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_retry_count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_consumer_count<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_pool<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_core<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">shutdown</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        KafkaAtLeastOnceConsumer<span class="token punctuation">.</span>run_flag <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token keyword">def</span> <span class="token function">_split_msgs</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> msgs<span class="token punctuation">:</span> List<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">:</span>
        msg_num <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span>
        <span class="token keyword">if</span> msg_num <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>_process_num_per_thread <span class="token operator">*</span> self<span class="token punctuation">.</span>_concurrency<span class="token punctuation">:</span>
            process_num_per_thread <span class="token operator">=</span> self<span class="token punctuation">.</span>_process_num_per_thread
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            process_num_per_thread <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>msg_num <span class="token operator">/</span> self<span class="token punctuation">.</span>_concurrency<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span>chunked<span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> process_num_per_thread<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_core</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            consumer <span class="token operator">=</span> self<span class="token punctuation">.</span>_init_consumer<span class="token punctuation">(</span><span class="token punctuation">)</span>
            batch_pool <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>self<span class="token punctuation">.</span>_concurrency<span class="token punctuation">)</span>
            <span class="token keyword">while</span> KafkaAtLeastOnceConsumer<span class="token punctuation">.</span>run_flag<span class="token punctuation">:</span>
                msgs <span class="token operator">=</span> consumer<span class="token punctuation">.</span>consume<span class="token punctuation">(</span>num_messages<span class="token operator">=</span>self<span class="token punctuation">.</span>_batch_size<span class="token punctuation">,</span> timeout<span class="token operator">=</span>self<span class="token punctuation">.</span>_timeout<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> msgs<span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>
                <span class="token keyword">if</span> config<span class="token punctuation">.</span>DEBUG<span class="token punctuation">:</span>
                    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'å¼€å§‹å¤„ç†ä¸€æ‰¹æ¶ˆæ¯'</span></span><span class="token punctuation">)</span>
                msg_lists <span class="token operator">=</span> self<span class="token punctuation">.</span>_split_msgs<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">)</span>
                threads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token keyword">for</span> msg_list <span class="token keyword">in</span> msg_lists<span class="token punctuation">:</span>
                    t <span class="token operator">=</span> batch_pool<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_thread_run<span class="token punctuation">,</span> msg_list<span class="token punctuation">)</span>
                    threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
                wait<span class="token punctuation">(</span>threads<span class="token punctuation">)</span>
                consumer<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> config<span class="token punctuation">.</span>DEBUG<span class="token punctuation">:</span>
                    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'å®Œæˆå¤„ç†ä¸€æ‰¹æ¶ˆæ¯'</span></span><span class="token punctuation">)</span>
                    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'total_set:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>KafkaAtLeastOnceConsumer<span class="token punctuation">.</span>total_set<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
                    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            log<span class="token punctuation">.</span>exception<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> consumer<span class="token punctuation">:</span>
                    consumer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> batch_pool<span class="token punctuation">:</span>
                    batch_pool<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                log<span class="token punctuation">.</span>exception<span class="token punctuation">(</span>e<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_thread_run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> msg_list<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> msg <span class="token keyword">in</span> msg_list<span class="token punctuation">:</span>
            msg_map <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">'old_topic'</span> <span class="token keyword">in</span> msg_map <span class="token keyword">and</span> msg_map<span class="token punctuation">[</span><span class="token string">'old_topic'</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>_topic_list<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            <span class="token keyword">try</span><span class="token punctuation">:</span>
                func_is_success <span class="token operator">=</span> self<span class="token punctuation">.</span>_user_function<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
                func_is_success <span class="token operator">=</span> <span class="token boolean">False</span>

            <span class="token keyword">if</span> <span class="token keyword">not</span> func_is_success<span class="token punctuation">:</span>
                <span class="token keyword">if</span> msg<span class="token punctuation">.</span>topic<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>_retry_topic_name<span class="token punctuation">:</span>
                    try_count <span class="token operator">=</span> msg_map<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'try_count'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    try_count <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>_retry_count <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>_retry_count <span class="token operator">&lt;=</span> try_count<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token comment"># é‡è¯•æ“ä½œ</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_inner_producer<span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>_inner_producer <span class="token operator">=</span> self<span class="token punctuation">.</span>_init_producer<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    msg_map<span class="token punctuation">[</span><span class="token string">'try_count'</span><span class="token punctuation">]</span> <span class="token operator">=</span> try_count <span class="token operator">+</span> <span class="token number">1</span>
                    msg_map<span class="token punctuation">[</span><span class="token string">'old_topic'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_topic_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                    self<span class="token punctuation">.</span>_inner_producer<span class="token punctuation">.</span>produce<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_retry_topic_name<span class="token punctuation">,</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>msg_map<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> config<span class="token punctuation">.</span>DEBUG<span class="token punctuation">:</span>
                KafkaAtLeastOnceConsumer<span class="token punctuation">.</span>total_set<span class="token punctuation">.</span>add<span class="token punctuation">(</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'t'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_init_consumer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Consumer<span class="token punctuation">:</span>
        _consumer <span class="token operator">=</span> Consumer<span class="token punctuation">(</span>
            <span class="token punctuation">{</span>
                <span class="token string">'bootstrap.servers'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_servers<span class="token punctuation">,</span>
                <span class="token string">'group.id'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_group_id<span class="token punctuation">,</span>
                <span class="token string">'auto.offset.reset'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_reset_type<span class="token punctuation">,</span>
                <span class="token string">'enable.auto.commit'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
        _consumer<span class="token punctuation">.</span>subscribe<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_topic_list<span class="token punctuation">)</span>
        <span class="token keyword">return</span> _consumer

    <span class="token keyword">def</span> <span class="token function">_init_producer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Producer<span class="token punctuation">:</span>
        _producer <span class="token operator">=</span> Producer<span class="token punctuation">(</span>
            <span class="token punctuation">{</span>
                <span class="token string">'bootstrap.servers'</span><span class="token punctuation">:</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>KAFKA_HOST<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> _producer
</code></pre></div><ol><li>åŒæ—¶å¼€å¯ consumer_count ä¸ªæ¶ˆè´¹è€…å¹¶å¤„äºåŒä¸€åˆ†ç»„ä¸­ï¼Œä¸ºäº†æé«˜ååé‡ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…åˆä¼šå¼€å¯ concurrency ä¸ªçº¿ç¨‹å»æ¶ˆè´¹æ•°æ®</li> <li>å½“æ¶ˆè´¹æ¶ˆè´¹å‡ºç°å¼‚å¸¸æˆ–è¿”å›Falseï¼Œå¹¶ä¸”é‡è¯•æ¬¡æ•°æ²¡æœ‰ä½¿ç”¨å®Œæ¯•ï¼Œå°±ä¼šå°†åˆå§‹æ¶ˆæ¯ä»¥åŠé‡è¯•æ¬¡æ•°å‘é€åˆ°â€œé‡è¯•é˜Ÿåˆ—â€</li> <li>å…³é—­è‡ªåŠ¨æäº¤ï¼Œå¼€å¯æ‰‹åŠ¨æäº¤ï¼Œå½“æ¶ˆè´¹è€…ç«¯å´©æºƒæˆ–å†å¹³è¡¡æ—¶å†æ¬¡æ¶ˆè´¹æœªæäº¤æ•°æ®ã€‚</li></ol> <p>æµ‹è¯•ä»£ç ï¼š</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_get_msg_data</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> msg<span class="token punctuation">.</span>partition<span class="token punctuation">(</span><span class="token punctuation">)</span>
    o <span class="token operator">=</span> msg<span class="token punctuation">.</span>offset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t <span class="token operator">=</span> msg<span class="token punctuation">.</span>topic<span class="token punctuation">(</span><span class="token punctuation">)</span>
    value <span class="token operator">=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> p<span class="token punctuation">,</span> o<span class="token punctuation">,</span> t<span class="token punctuation">,</span> value


<span class="token keyword">def</span> <span class="token function">my_function</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> msg<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'fetch msg is error. error:%s'</span> <span class="token operator">%</span> msg<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token comment"># å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œå•æ¬¡é—®é¢˜è¿›è¡Œé‡è¯•</span>
    p<span class="token punctuation">,</span> o<span class="token punctuation">,</span> t<span class="token punctuation">,</span> value <span class="token operator">=</span> _get_msg_data<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">if</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">9</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;å‘ç”Ÿä¸šåŠ¡å¼‚å¸¸è¿”å›False, topic:</span><span class="token interpolation"><span class="token punctuation">{</span>t<span class="token punctuation">}</span></span><span class="token string">, partition:</span><span class="token interpolation"><span class="token punctuation">{</span>p<span class="token punctuation">}</span></span><span class="token string">,  offset </span><span class="token interpolation"><span class="token punctuation">{</span>o<span class="token punctuation">}</span></span><span class="token string">, value:</span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">[</span><span class="token string">'t'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> &quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'ä¸šåŠ¡å¤„ç†æ¶ˆæ¯ï¼Œtopic:</span><span class="token interpolation"><span class="token punctuation">{</span>t<span class="token punctuation">}</span></span><span class="token string">, partition:</span><span class="token interpolation"><span class="token punctuation">{</span>p<span class="token punctuation">}</span></span><span class="token string">, offset:</span><span class="token interpolation"><span class="token punctuation">{</span>o<span class="token punctuation">}</span></span><span class="token string">, content:</span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token keyword">def</span> <span class="token function">success_function</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œå®Œå…¨æ­£å¸¸</span>
    <span class="token keyword">if</span> msg<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'fetch msg is error. error:%s'</span> <span class="token operator">%</span> msg<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    p<span class="token punctuation">,</span> o<span class="token punctuation">,</span> t<span class="token punctuation">,</span> value <span class="token operator">=</span> _get_msg_data<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'ä¸šåŠ¡å¤„ç†æ¶ˆæ¯ï¼Œtopic:</span><span class="token interpolation"><span class="token punctuation">{</span>t<span class="token punctuation">}</span></span><span class="token string">, partition:</span><span class="token interpolation"><span class="token punctuation">{</span>p<span class="token punctuation">}</span></span><span class="token string">, offset:</span><span class="token interpolation"><span class="token punctuation">{</span>o<span class="token punctuation">}</span></span><span class="token string">, content:</span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token keyword">def</span> <span class="token function">exception_function</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼ŒæŠ›å‡ºå¼‚å¸¸é‡è¯•</span>
    <span class="token keyword">if</span> msg<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'fetch msg is error. error:%s'</span> <span class="token operator">%</span> msg<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    p<span class="token punctuation">,</span> o<span class="token punctuation">,</span> t<span class="token punctuation">,</span> value <span class="token operator">=</span> _get_msg_data<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">if</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">9</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;å‘ç”Ÿä¸šåŠ¡å¼‚å¸¸è¿”å›False, topic:</span><span class="token interpolation"><span class="token punctuation">{</span>t<span class="token punctuation">}</span></span><span class="token string">, partition:</span><span class="token interpolation"><span class="token punctuation">{</span>p<span class="token punctuation">}</span></span><span class="token string">,  offset </span><span class="token interpolation"><span class="token punctuation">{</span>o<span class="token punctuation">}</span></span><span class="token string">, value:</span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">[</span><span class="token string">'t'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> &quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'ä¸šåŠ¡å¼‚å¸¸'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'ä¸šåŠ¡å¤„ç†æ¶ˆæ¯ï¼Œtopic:</span><span class="token interpolation"><span class="token punctuation">{</span>t<span class="token punctuation">}</span></span><span class="token string">, partition:</span><span class="token interpolation"><span class="token punctuation">{</span>p<span class="token punctuation">}</span></span><span class="token string">, offset:</span><span class="token interpolation"><span class="token punctuation">{</span>o<span class="token punctuation">}</span></span><span class="token string">, content:</span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token keyword">def</span> <span class="token function">test_normal_try_limit</span><span class="token punctuation">(</span>retry_count<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ç”¨æˆ·å‡½æ•°è¿”å›falseé‡è¯•(-1æ— é™/æ•°å­—ä¸ºé‡è¯•æ¬¡æ•°)</span>
    consumer <span class="token operator">=</span> KafkaAtLeastOnceConsumer<span class="token punctuation">(</span>group_id<span class="token punctuation">,</span> <span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">,</span> my_function<span class="token punctuation">,</span> retry_count<span class="token operator">=</span>retry_count<span class="token punctuation">)</span>
    consumer<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">test_exception_try_limit</span><span class="token punctuation">(</span>retry_count<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># å¼‚å¸¸æŒ‡å®šé‡è¯•æ¬¡æ•°(-1æ— é™/æ•°å­—ä¸ºé‡è¯•æ¬¡æ•°)</span>
    consumer <span class="token operator">=</span> KafkaAtLeastOnceConsumer<span class="token punctuation">(</span>group_id<span class="token punctuation">,</span> <span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">,</span> exception_function<span class="token punctuation">,</span> retry_count<span class="token operator">=</span>retry_count<span class="token punctuation">)</span>
    consumer<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">test_normal_no_try</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># åŸºæœ¬æ¨¡å¼</span>
    consumer <span class="token operator">=</span> KafkaAtLeastOnceConsumer<span class="token punctuation">(</span>group_id<span class="token punctuation">,</span> <span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">,</span> my_function<span class="token punctuation">,</span> base_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    consumer<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">test_crash_consume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># æ¨¡æ‹Ÿæ¶ˆè´¹è€…å…³åœ/å´©æºƒï¼Œæ¶ˆè´¹è€…ç»§ç»­æ¶ˆè´¹</span>
    consumer <span class="token operator">=</span> KafkaAtLeastOnceConsumer<span class="token punctuation">(</span>group_id<span class="token punctuation">,</span> <span class="token punctuation">[</span>topic<span class="token punctuation">]</span><span class="token punctuation">,</span> success_function<span class="token punctuation">,</span> base_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    consumer<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
    consumer<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    test_channel <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> test_channel <span class="token operator">==</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">:</span>
        test_normal_try_limit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> test_channel <span class="token operator">==</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">:</span>
        test_normal_try_limit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> test_channel <span class="token operator">==</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">:</span>
        test_exception_try_limit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> test_channel <span class="token operator">==</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">:</span>
        test_exception_try_limit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> test_channel <span class="token operator">==</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">:</span>
        test_normal_no_try<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> test_channel <span class="token operator">==</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">:</span>
        test_crash_consume<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        test_normal_try_limit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="ä½¿ç”¨seekæ–¹æ³•å†æ¬¡æ¶ˆè´¹"><a href="#ä½¿ç”¨seekæ–¹æ³•å†æ¬¡æ¶ˆè´¹" class="header-anchor">#</a> ä½¿ç”¨seekæ–¹æ³•å†æ¬¡æ¶ˆè´¹</h3> <p>ç†è®ºä¸Šæ¥è®²ï¼Œè¿™ç§æ–¹æ³•æ˜¯èƒ½è¡Œçš„é€šçš„ã€‚å› ä¸ºseekèƒ½å°†ä¸€ä¸ªæ´»è·ƒåˆ†åŒºçš„æ¶ˆè´¹ä½ç§»è®¾ç½®åˆ°æ¶ˆè´¹å¤±è´¥çš„ä½ç½®ï¼Œç„¶åä¸‹ä¸€æ¬¡æ‹‰å–æ—¶å¯ä»¥é‡æ–°è·å–è¯¥æ•°æ®ï¼Œå¹¶ä¸”ç›¸æ¯”ä½¿ç”¨â€œé‡è¯•é˜Ÿåˆ—â€ï¼Œseekæ–¹å¼è¿˜å¯ä»¥ä¿è¯æ¶ˆæ¯éƒ¨åˆ†é¡ºåºã€‚
ä½†æ˜¯seekåœ¨æ‰¹é‡å¤„ç†ä¸‹å­˜åœ¨<a href="https://github.com/confluentinc/confluent-kafka-python/issues/1443" target="_blank" rel="noopener noreferrer">æœªçŸ¥é—®é¢˜<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ï¼Œåé¢å†ç ”ç©¶ã€‚</p></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/LearingWord/tags/?tag=%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" title="æ ‡ç­¾">#æ¶ˆæ¯é˜Ÿåˆ—</a></div> <!----></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/LearingWord/archives/" class="iconfont icon-bi">æœ€è¿‘æ›´æ–°</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/LearingWord/home.html"><div>
            é¡¹ç›®ç›¸å…³
            <!----></div></a> <span class="date"></span></dt></dl><dl><dd>02</dd> <dt><a href="/LearingWord/high-performance/message-queue/deploy-kafka-cluster-3-3-1/"><div>
            å•æœºDockeréƒ¨ç½²åº”ç”¨Kraftæ¨¡å¼çš„Kafkaé›†ç¾¤
            <!----></div></a> <span class="date">01-02</span></dt></dl><dl><dd>03</dd> <dt><a href="/LearingWord/database/redis/redis-big-key-question/"><div>
            Redis å¤§Keyé—®é¢˜
            <!----></div></a> <span class="date">12-17</span></dt></dl> <dl><dd></dd> <dt><a href="/LearingWord/archives/" class="more">æ›´å¤šæ–‡ç« &gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:673052752@qq.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://blog.csdn.net/qq_39410381?type=blog" title="csdn" target="_blank" class="iconfont icon-csdn"></a><a href="https://github.com/04sky" title="github" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/sikailin" title="gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> <!----></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/LearingWord/assets/js/app.352ff452.js" defer></script><script src="/LearingWord/assets/js/2.a91a21bc.js" defer></script><script src="/LearingWord/assets/js/6.9f44c348.js" defer></script>
  </body>
</html>
