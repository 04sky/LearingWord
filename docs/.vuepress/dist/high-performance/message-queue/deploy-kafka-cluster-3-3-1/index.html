<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>单机Docker部署应用Kraft模式的Kafka集群 | LearnWord</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="专注技术分享，从后端八股到实践">
    
    <link rel="preload" href="/LearingWord/assets/css/0.styles.8ee1b52f.css" as="style"><link rel="preload" href="/LearingWord/assets/js/app.385fc0f7.js" as="script"><link rel="preload" href="/LearingWord/assets/js/2.a91a21bc.js" as="script"><link rel="preload" href="/LearingWord/assets/js/3.6240dd65.js" as="script"><link rel="prefetch" href="/LearingWord/assets/js/10.369fded9.js"><link rel="prefetch" href="/LearingWord/assets/js/11.e542d95b.js"><link rel="prefetch" href="/LearingWord/assets/js/12.453058ae.js"><link rel="prefetch" href="/LearingWord/assets/js/4.acaee825.js"><link rel="prefetch" href="/LearingWord/assets/js/5.b66c11d1.js"><link rel="prefetch" href="/LearingWord/assets/js/6.31f6ea18.js"><link rel="prefetch" href="/LearingWord/assets/js/7.d8849348.js"><link rel="prefetch" href="/LearingWord/assets/js/8.f911e6d4.js"><link rel="prefetch" href="/LearingWord/assets/js/9.68efdfcb.js">
    <link rel="stylesheet" href="/LearingWord/assets/css/0.styles.8ee1b52f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open no-sidebar have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/LearingWord/" class="home-link router-link-active"><!----> <span class="site-name">LearnWord</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/LearingWord/" class="nav-link">主页</a></div><div class="nav-item"><a href="/LearingWord/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/LearingWord/home.html" class="nav-link">LearnWord</a></div><div class="nav-item"><a href="/LearingWord/books/" class="nav-link">推荐书籍</a></div><div class="nav-item"><a href="/LearingWord/wechat-official-accounts/" class="nav-link">公众号</a></div><div class="nav-item"><a href="/LearingWord/about/" class="nav-link">关于</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/LearingWord/" class="nav-link">主页</a></div><div class="nav-item"><a href="/LearingWord/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/LearingWord/home.html" class="nav-link">LearnWord</a></div><div class="nav-item"><a href="/LearingWord/books/" class="nav-link">推荐书籍</a></div><div class="nav-item"><a href="/LearingWord/wechat-official-accounts/" class="nav-link">公众号</a></div><div class="nav-item"><a href="/LearingWord/about/" class="nav-link">关于</a></div> <!----></nav>  <!----> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/LearingWord/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/LearingWord/categories/?category=high-performance" title="分类" data-v-06225672>high-performance</a></li><li data-v-06225672><a href="/LearingWord/categories/?category=message-queue" title="分类" data-v-06225672>message-queue</a></li></ul> <div class="info" data-v-06225672><!----> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-01-02</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">单机Docker部署应用Kraft模式的Kafka集群<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="_1-docker镜像准备"><a href="#_1-docker镜像准备" class="header-anchor">#</a> 1 Docker镜像准备</h2> <p>因为这里需要使用Docker模式3台主机，因此以ubuntu系统为基础，封装自己的镜像。</p> <h3 id="_1-1-下载kafka"><a href="#_1-1-下载kafka" class="header-anchor">#</a> 1.1 下载Kafka</h3> <p>下载 <code>kafka_2.12-3.3.1.tgz</code> 到本地（/home/linsikai/lib/node1），下载地址：<a href="https://downloads.apache.org/kafka/3.3.1/kafka_2.12-3.3.1.tgz" target="_blank" rel="noopener noreferrer">kafka_2.12-3.3.1.tgz下载<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_1-2-配置容器"><a href="#_1-2-配置容器" class="header-anchor">#</a> 1.2 配置容器</h3> <ol><li>以ubuntu系统为底创建容器</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">sudo</span> <span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">-v</span> /home/linsikai/tmp/node1/kraft-combined-logs:/tmp/kraft-combined-logs <span class="token parameter variable">-v</span> /home/linsikai/lib/node1:/lib/node <span class="token parameter variable">--name</span> kafka-raft-node ubuntu:latest /bin/bash
</code></pre></div><ol start="2"><li>安装Java：<code>apt-get update -y &amp; apt-get install openjdk-11-jdk -y</code></li></ol> <blockquote><p>注意：自kafka3.0开始，java8已被标注舍弃，并且将于kafka4.0彻底废弃。推荐使用java11、java17</p></blockquote> <ol start="3"><li>安装Vim：<code>apt-get install vim -y</code></li> <li>封装镜像：<code>sudo docker commit [容器id] sky/kafka-kraft:0.0.1</code></li></ol> <p><img src="/LearingWord/assets/img/kafka-3-3-1-image.d0a19930.png" alt="kafa-3-3-1-image.png"></p> <h3 id="_1-3-修改kafka配置"><a href="#_1-3-修改kafka配置" class="header-anchor">#</a> 1.3 修改kafka配置</h3> <p>复制三份kafka解压数据，并分别进入kafka安装目录（<code>/home/linsikai/lib/node1</code>，<code>/home/linsikai/lib/node2</code>，<code>/home/linsikai/lib/node2</code>），打开配置文件：<code>vim config/kraft/server.properties</code></p> <ol><li>node1节点配置，kraft需要注意的配置项包括以下：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># The role of this server. Setting this puts us in KRaft mode</span>
<span class="token assign-left variable">process.roles</span><span class="token operator">=</span>broker,controller

<span class="token comment"># The node id associated with this instance's roles</span>
<span class="token assign-left variable">node.id</span><span class="token operator">=</span><span class="token number">1</span>

<span class="token comment"># The connect string for the controller quorum</span>
<span class="token assign-left variable">controller.quorum.voters</span><span class="token operator">=</span><span class="token number">1</span>@127.0.0.1:9033,2@127.0.0.1:9034,3@127.0.0.1:9035

<span class="token comment"># The address the socket server listens on.</span>
<span class="token comment"># Combined nodes (i.e. those with `process.roles=broker,controller`) must list the controller listener here at a minimum.</span>
<span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://:9023,CONTROLLER://:9033

<span class="token comment"># Name of listener used for communication between brokers.</span>
<span class="token assign-left variable">inter.broker.listener.name</span><span class="token operator">=</span>PLAINTEXT

<span class="token comment"># Listener name, hostname and port the broker will advertise to clients.</span>
<span class="token comment"># If not set, it uses the value for &quot;listeners&quot;.</span>
<span class="token assign-left variable">advertised.listeners</span><span class="token operator">=</span>PLAINTEXT://127.0.0.1:9023

<span class="token comment"># A comma-separated list of the names of the listeners used by the controller.</span>
<span class="token comment"># If no explicit mapping set in `listener.security.protocol.map`, default will be using PLAINTEXT protocol</span>
<span class="token comment"># This is required if running in KRaft mode.</span>
<span class="token assign-left variable">controller.listener.names</span><span class="token operator">=</span>CONTROLLER

<span class="token comment"># A comma separated list of directories under which to store log files</span>
<span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/tmp/kraft-combined-logs
</code></pre></div><p>（2）node2节点配置</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># The role of this server. Setting this puts us in KRaft mode</span>
<span class="token assign-left variable">process.roles</span><span class="token operator">=</span>broker,controller

<span class="token comment"># The node id associated with this instance's roles</span>
<span class="token assign-left variable">node.id</span><span class="token operator">=</span><span class="token number">2</span>

<span class="token comment"># The connect string for the controller quorum</span>
<span class="token assign-left variable">controller.quorum.voters</span><span class="token operator">=</span><span class="token number">1</span>@127.0.0.1:9033,2@127.0.0.1:9034,3@127.0.0.1:9035

<span class="token comment"># The address the socket server listens on.</span>
<span class="token comment"># Combined nodes (i.e. those with `process.roles=broker,controller`) must list the controller listener here at a minimum.</span>
<span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://:9024,CONTROLLER://:9034

<span class="token comment"># Name of listener used for communication between brokers.</span>
<span class="token assign-left variable">inter.broker.listener.name</span><span class="token operator">=</span>PLAINTEXT

<span class="token comment"># Listener name, hostname and port the broker will advertise to clients.</span>
<span class="token comment"># If not set, it uses the value for &quot;listeners&quot;.</span>
<span class="token assign-left variable">advertised.listeners</span><span class="token operator">=</span>PLAINTEXT://127.0.0.1:9024

<span class="token comment"># A comma-separated list of the names of the listeners used by the controller.</span>
<span class="token comment"># If no explicit mapping set in `listener.security.protocol.map`, default will be using PLAINTEXT protocol</span>
<span class="token comment"># This is required if running in KRaft mode.</span>
<span class="token assign-left variable">controller.listener.names</span><span class="token operator">=</span>CONTROLLER

<span class="token comment"># A comma separated list of directories under which to store log files</span>
<span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/tmp/kraft-combined-logs
</code></pre></div><p>（3）node3节点</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># The role of this server. Setting this puts us in KRaft mode</span>
<span class="token assign-left variable">process.roles</span><span class="token operator">=</span>broker,controller

<span class="token comment"># The node id associated with this instance's roles</span>
<span class="token assign-left variable">node.id</span><span class="token operator">=</span><span class="token number">3</span>
`<span class="token variable"><span class="token variable">`</span>
<span class="token comment"># The connect string for the controller quorum</span>
<span class="token assign-left variable">controller.quorum.voters</span><span class="token operator">=</span><span class="token number">1</span>@127.0.0.1:9033,2@127.0.0.1:9034,3@127.0.0.1:9035

<span class="token comment"># The address the socket server listens on.</span>
<span class="token comment"># Combined nodes (i.e. those with </span><span class="token variable">`</span></span><span class="token assign-left variable">process.roles</span><span class="token operator">=</span>broker,controller<span class="token variable"><span class="token variable">`</span><span class="token punctuation">)</span> must list the controller listener here at a minimum.
<span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://:9025,CONTROLLER://:9035

<span class="token comment"># Name of listener used for communication between brokers.</span>
<span class="token assign-left variable">inter.broker.listener.name</span><span class="token operator">=</span>PLAINTEXT

<span class="token comment"># Listener name, hostname and port the broker will advertise to clients.</span>
<span class="token comment"># If not set, it uses the value for &quot;listeners&quot;.</span>
<span class="token assign-left variable">advertised.listeners</span><span class="token operator">=</span>PLAINTEXT://127.0.0.1:9025

<span class="token comment"># A comma-separated list of the names of the listeners used by the controller.</span>
<span class="token comment"># If no explicit mapping set in </span><span class="token variable">`</span></span>listener.security.protocol.map`, default will be using PLAINTEXT protocol
<span class="token comment"># This is required if running in KRaft mode.</span>
<span class="token assign-left variable">controller.listener.names</span><span class="token operator">=</span>CONTROLLER

<span class="token comment"># A comma separated list of directories under which to store log files</span>
<span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/tmp/kraft-combined-logs
</code></pre></div><h2 id="_2-部署kafka集群"><a href="#_2-部署kafka集群" class="header-anchor">#</a> 2 部署Kafka集群</h2> <h3 id="_2-1-启动节点容器"><a href="#_2-1-启动节点容器" class="header-anchor">#</a> 2.1 启动节点容器</h3> <p>分别启动3台节点容器</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> run <span class="token parameter variable">-itd</span> <span class="token parameter variable">--network</span> <span class="token function">host</span> <span class="token parameter variable">-v</span> /home/linsikai/tmp/node1/kraft-combined-logs:/tmp/kraft-combined-logs <span class="token parameter variable">-v</span> /home/linsikai/lib/node1:/lib/node <span class="token parameter variable">--name</span> kafka-raft-node1 sky/kafka-kraft:0.0.1 /bin/bash
<span class="token function">docker</span> run <span class="token parameter variable">-itd</span> <span class="token parameter variable">--network</span> <span class="token function">host</span> <span class="token parameter variable">-v</span> /home/linsikai/tmp/node2/kraft-combined-logs:/tmp/kraft-combined-logs <span class="token parameter variable">-v</span> /home/linsikai/lib/node2:/lib/node <span class="token parameter variable">--name</span> kafka-raft-node2 sky/kafka-kraft:0.0.1 /bin/bash
<span class="token function">docker</span> run <span class="token parameter variable">-itd</span> <span class="token parameter variable">--network</span> <span class="token function">host</span> <span class="token parameter variable">-v</span> /home/linsikai/tmp/node3/kraft-combined-logs:/tmp/kraft-combined-logs <span class="token parameter variable">-v</span> /home/linsikai/lib/node3:/lib/node <span class="token parameter variable">--name</span> kafka-raft-node3 sky/kafka-kraft:0.0.1 /bin/bash
</code></pre></div><p><img src="/LearingWord/assets/img/kafka-3-3-1-containers.3d3e8938.png" alt="kafka-3-3-1-containers.png"></p> <h3 id="_2-2-生成一个-cluster-id"><a href="#_2-2-生成一个-cluster-id" class="header-anchor">#</a> 2.2 生成一个 Cluster ID</h3> <p><code>sudo docker exec -it [容器id] /bin/bash</code>进入任意一个容器，执行下面：（其实也可以不用执行，测试的话写成AAAAAAA都可以，保证唯一就行）</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ ./bin/kafka-storage.sh random-uuid
TaMk2qkGSLaWEPo2ru86Kw
</code></pre></div><p>由以前自动生成改手动生成的原因参见：3.4小节 Kafka存储工具。</p> <h3 id="_2-3-格式化存储目录"><a href="#_2-3-格式化存储目录" class="header-anchor">#</a> 2.3 格式化存储目录</h3> <p>下一步是格式化存储目录。如果运行单节点，可以使用以下命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ ./bin/kafka-storage.sh <span class="token function">format</span> <span class="token parameter variable">-t</span> TaMk2qkGSLaWEPo2ru86Kw <span class="token parameter variable">-c</span> ./config/kraft/server.properties
Formatting /tmp/kraft-combined-logs with metadata.version <span class="token number">3.3</span>-IV3.
</code></pre></div><p>如果运行集群，需要给每个节点运行格式化命令。</p> <blockquote><p>注意：需要使用相同的集群 Cluster ID</p></blockquote> <h3 id="_2-4-启动kafka服务"><a href="#_2-4-启动kafka服务" class="header-anchor">#</a> 2.4 启动kafka服务</h3> <p>最后，启动每一个kafka节点。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ ./bin/kafka-server-start.sh ./config/kraft/server.properties

<span class="token comment"># 后台运行</span>
$ ./bin/kafka-server-start.sh <span class="token parameter variable">-daemon</span> ./config/kraft/server.properties
</code></pre></div><p>之后就可以愉快地玩耍了，例如常见topic</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ ./bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token parameter variable">--topic</span> foo <span class="token parameter variable">--partitions</span> <span class="token number">1</span> --replication-factor <span class="token number">1</span> --bootstrap-server <span class="token number">127.0</span>.0.1:9023
Created topic foo.
</code></pre></div><h2 id="_3-知识"><a href="#_3-知识" class="header-anchor">#</a> 3 知识</h2> <h3 id="_3-1-控制器服务器"><a href="#_3-1-控制器服务器" class="header-anchor">#</a> 3.1 控制器服务器</h3> <p>在KRaft模式下，只有一小部分服务器可以充当controller（与基于ZooKeeper的模式不同：任何服务器都可以成为controller）。被选择的controller将参与元数据仲裁。每个controller都处于活动状态，或者是当前活动controller的热备用状态。</p> <p>通常会为该角色选择3或5台服务器，这取决于成本和系统在不影响可用性的情况下应承受的并发故障数等因素。就像ZooKeeper一样，为了保持可用性，必须使大多数contrller保持活动状态。 因此，如果有3个控制器，可以容忍1个故障；使用5个控制器，可以容忍2个故障。</p> <h3 id="_3-2-进程角色"><a href="#_3-2-进程角色" class="header-anchor">#</a> 3.2 进程角色</h3> <p>现在，每个Kafka服务器都有一个名为<code>process.roles</code>的参数，其值如下：</p> <ul><li>broker：一个普通Kafka节点</li> <li>controller：一个Kafka控制器</li> <li>broker,controller：同时有broker、controller角色</li> <li>不设置：认为是ZooKeeper模式</li></ul> <p>充当broker和controller的节点称为“组合”节点。对于简单的用例，组合节点更易于操作。缺点是controller与系统的其余部分的隔离度较低。例如，如果broker上的活动导致内存不足，则服务器的controller不会与该OOM条件隔离。</p> <h3 id="_3-3-仲裁投票者"><a href="#_3-3-仲裁投票者" class="header-anchor">#</a> 3.3 仲裁投票者</h3> <p>系统中的所有节点都必须设置<code>controller.quorum.voters</code>参数。这标识了应该使用的仲裁controller，必须枚举所有controller。这类似于使用ZooKeeper时，<code>ZooKeeper.connect</code>配置必须包含所有ZooKeeperServer。然而与ZooKeeper配置不同是，“controller.quorum.voters”参数也具有每个节点的ID。格式为 <code>id1@host1:port1,id2@host2:port2</code> 等。</p> <p>因此，如果有10个broker和3个名为 controller1、controller2、controller3 的controller，那么可能在controller1上具有以下配置：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token assign-left variable">process.roles</span><span class="token operator">=</span>controller
<span class="token assign-left variable">node.id</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">listeners</span><span class="token operator">=</span>CONTROLLER://controller1.example.com:9093
<span class="token assign-left variable">controller.quorum.voters</span><span class="token operator">=</span><span class="token number">1</span>@controller1.example.com:9093,2@controller2.example.com:9093,3@controller3.example.com:9093
</code></pre></div><p>每个broker和每个controller都必须设置<code>controller.quorum.voters</code>。请注意，<code>controller.quorum.voters</code>配置中提供的节点ID必须与提供给服务器的节点ID匹配。因此，在controller1上，node.id必须设置为1，依此类推。注意，controller ID不需要从0或1开始。然而，分配节点ID的最简单和最不容易混淆的方法可能只是给每个服务器一个数字ID，从0开始。还要注意，每个节点ID在特定集群中的所有节点上必须是唯一的；任何两个节点都不能具有相同的节点ID，而不管其“process.roles”值如何。</p> <h3 id="_3-4-kafka存储工具"><a href="#_3-4-kafka存储工具" class="header-anchor">#</a> 3.4 Kafka存储工具</h3> <p>如上所述，在快速开始部分中，必须使用<code>kafka storage.sh</code>工具为新集群生成Cluster ID，然后在启动节点之前在每个节点上运行格式化命令。</p> <blockquote><p>在1.0和2.0的版本里面，集群ID是自动生成的，存储数据目录是自动生成的。那为什么在3.0会这样做呢？</p></blockquote> <p>社区的的思考是这样子的，即自动格式化有时候会掩盖一些异常，比如，在Unix中，如果一个数据目录不能被挂载，它可能显示为空白，在这种情况下，自动格式化将是将会带来一些问题。这个特性对于 Controller 服务器维护元数据日志特别重要，因为如果三个 Controller 节点中有两个能够从空白日志开始，那么可能会在日志中没有任何内容的情况下，选出一个Leader，这会导致所有的元数据丢失(KRaft 仲裁后发生截断)。一旦发生这个问题，将会是不可逆的故障。</p> <h3 id="_3-5-缺失的能力"><a href="#_3-5-缺失的能力" class="header-anchor">#</a> 3.5 缺失的能力</h3> <p>以下特性还未完全实现：</p> <ul><li>通过管理API配置SCRAM用户</li> <li>支持具有多个存储目录的JBOD配置</li> <li>修改单独阳性KRaft controller上的某些动态配置</li> <li>委派令牌</li> <li>从ZooKeeper模式升级</li></ul> <h3 id="_3-6-debug"><a href="#_3-6-debug" class="header-anchor">#</a> 3.6 Debug</h3> <p>如果遇到问题，可能需要查看元数据日志。</p> <h4 id="_3-6-1-kafka-dump-log"><a href="#_3-6-1-kafka-dump-log" class="header-anchor">#</a> 3.6.1 kafka-dump-log</h4> <p>查看元数据日志的一种方法是使用<code>kafka-dump-log.sh</code>工具，如下所示：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ ./bin/kafka-dump-log.sh  --cluster-metadata-decoder --skip-record-metadata <span class="token parameter variable">--files</span> /tmp/kraft-combined-logs/__cluster_metadata-0/*.log
Dumping /tmp/kraft-combined-logs/__cluster_metadata-0/00000000000000000000.log
Starting offset: <span class="token number">0</span>
baseOffset: <span class="token number">0</span> lastOffset: <span class="token number">0</span> count: <span class="token number">1</span> baseSequence: <span class="token parameter variable">-1</span> lastSequence: <span class="token parameter variable">-1</span> producerId: <span class="token parameter variable">-1</span> producerEpoch: <span class="token parameter variable">-1</span> partitionLeaderEpoch: <span class="token number">1</span> isTransactional: <span class="token boolean">false</span> isControl: <span class="token boolean">true</span> position: <span class="token number">0</span> CreateTime: <span class="token number">1614382631640</span> size: <span class="token number">89</span> magic: <span class="token number">2</span> compresscodec: NONE crc: <span class="token number">1438115474</span> isvalid: <span class="token boolean">true</span>

baseOffset: <span class="token number">1</span> lastOffset: <span class="token number">1</span> count: <span class="token number">1</span> baseSequence: <span class="token parameter variable">-1</span> lastSequence: <span class="token parameter variable">-1</span> producerId: <span class="token parameter variable">-1</span> producerEpoch: <span class="token parameter variable">-1</span> partitionLeaderEpoch: <span class="token number">1</span> isTransactional: <span class="token boolean">false</span> isControl: <span class="token boolean">false</span> position: <span class="token number">89</span> CreateTime: <span class="token number">1614382632329</span> size: <span class="token number">137</span> magic: <span class="token number">2</span> compresscodec: NONE crc: <span class="token number">1095855865</span> isvalid: <span class="token boolean">true</span>
payload: <span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;REGISTER_BROKER_RECORD&quot;</span>,<span class="token string">&quot;version&quot;</span>:0,<span class="token string">&quot;data&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;brokerId&quot;</span>:1,<span class="token string">&quot;incarnationId&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;P3UFsWoNR-erL9PK98YLsA&quot;</span>,<span class="token string">&quot;brokerEpoch&quot;</span>:0,<span class="token string">&quot;endPoints&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;PLAINTEXT&quot;</span>,<span class="token string">&quot;host&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;localhost&quot;</span>,<span class="token string">&quot;port&quot;</span>:9092,<span class="token string">&quot;securityProtocol&quot;</span>:0<span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">&quot;features&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">]</span>,<span class="token string">&quot;rack&quot;</span>:null<span class="token punctuation">}</span><span class="token punctuation">}</span>
baseOffset: <span class="token number">2</span> lastOffset: <span class="token number">2</span> count: <span class="token number">1</span> baseSequence: <span class="token parameter variable">-1</span> lastSequence: <span class="token parameter variable">-1</span> producerId: <span class="token parameter variable">-1</span> producerEpoch: <span class="token parameter variable">-1</span> partitionLeaderEpoch: <span class="token number">1</span> isTransactional: <span class="token boolean">false</span> isControl: <span class="token boolean">false</span> position: <span class="token number">226</span> CreateTime: <span class="token number">1614382632453</span> size: <span class="token number">83</span> magic: <span class="token number">2</span> compresscodec: NONE crc: <span class="token number">455187130</span> isvalid: <span class="token boolean">true</span>
payload: <span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;UNFENCE_BROKER_RECORD&quot;</span>,<span class="token string">&quot;version&quot;</span>:0,<span class="token string">&quot;data&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:1,<span class="token string">&quot;epoch&quot;</span>:0<span class="token punctuation">}</span><span class="token punctuation">}</span>
baseOffset: <span class="token number">3</span> lastOffset: <span class="token number">3</span> count: <span class="token number">1</span> baseSequence: <span class="token parameter variable">-1</span> lastSequence: <span class="token parameter variable">-1</span> producerId: <span class="token parameter variable">-1</span> producerEpoch: <span class="token parameter variable">-1</span> partitionLeaderEpoch: <span class="token number">1</span> isTransactional: <span class="token boolean">false</span> isControl: <span class="token boolean">false</span> position: <span class="token number">309</span> CreateTime: <span class="token number">1614382634484</span> size: <span class="token number">83</span> magic: <span class="token number">2</span> compresscodec: NONE crc: <span class="token number">4055692847</span> isvalid: <span class="token boolean">true</span>
payload: <span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;FENCE_BROKER_RECORD&quot;</span>,<span class="token string">&quot;version&quot;</span>:0,<span class="token string">&quot;data&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:1,<span class="token string">&quot;epoch&quot;</span>:0<span class="token punctuation">}</span><span class="token punctuation">}</span>
baseOffset: <span class="token number">4</span> lastOffset: <span class="token number">4</span> count: <span class="token number">1</span> baseSequence: <span class="token parameter variable">-1</span> lastSequence: <span class="token parameter variable">-1</span> producerId: <span class="token parameter variable">-1</span> producerEpoch: <span class="token parameter variable">-1</span> partitionLeaderEpoch: <span class="token number">2</span> isTransactional: <span class="token boolean">false</span> isControl: <span class="token boolean">true</span> position: <span class="token number">392</span> CreateTime: <span class="token number">1614382671857</span> size: <span class="token number">89</span> magic: <span class="token number">2</span> compresscodec: NONE crc: <span class="token number">1318571838</span> isvalid: <span class="token boolean">true</span>

baseOffset: <span class="token number">5</span> lastOffset: <span class="token number">5</span> count: <span class="token number">1</span> baseSequence: <span class="token parameter variable">-1</span> lastSequence: <span class="token parameter variable">-1</span> producerId: <span class="token parameter variable">-1</span> producerEpoch: <span class="token parameter variable">-1</span> partitionLeaderEpoch: <span class="token number">2</span> isTransactional: <span class="token boolean">false</span> isControl: <span class="token boolean">false</span> position: <span class="token number">481</span> CreateTime: <span class="token number">1614382672440</span> size: <span class="token number">137</span> magic: <span class="token number">2</span> compresscodec: NONE crc: <span class="token number">841144615</span> isvalid: <span class="token boolean">true</span>
payload: <span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;REGISTER_BROKER_RECORD&quot;</span>,<span class="token string">&quot;version&quot;</span>:0,<span class="token string">&quot;data&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;brokerId&quot;</span>:1,<span class="token string">&quot;incarnationId&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;RXRJu7cnScKRZOnWQGs86g&quot;</span>,<span class="token string">&quot;brokerEpoch&quot;</span>:4,<span class="token string">&quot;endPoints&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;PLAINTEXT&quot;</span>,<span class="token string">&quot;host&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;localhost&quot;</span>,<span class="token string">&quot;port&quot;</span>:9092,<span class="token string">&quot;securityProtocol&quot;</span>:0<span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">&quot;features&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">]</span>,<span class="token string">&quot;rack&quot;</span>:null<span class="token punctuation">}</span><span class="token punctuation">}</span>
baseOffset: <span class="token number">6</span> lastOffset: <span class="token number">6</span> count: <span class="token number">1</span> baseSequence: <span class="token parameter variable">-1</span> lastSequence: <span class="token parameter variable">-1</span> producerId: <span class="token parameter variable">-1</span> producerEpoch: <span class="token parameter variable">-1</span> partitionLeaderEpoch: <span class="token number">2</span> isTransactional: <span class="token boolean">false</span> isControl: <span class="token boolean">false</span> position: <span class="token number">618</span> CreateTime: <span class="token number">1614382672544</span> size: <span class="token number">83</span> magic: <span class="token number">2</span> compresscodec: NONE crc: <span class="token number">4155905922</span> isvalid: <span class="token boolean">true</span>
payload: <span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;UNFENCE_BROKER_RECORD&quot;</span>,<span class="token string">&quot;version&quot;</span>:0,<span class="token string">&quot;data&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:1,<span class="token string">&quot;epoch&quot;</span>:4<span class="token punctuation">}</span><span class="token punctuation">}</span>
baseOffset: <span class="token number">7</span> lastOffset: <span class="token number">8</span> count: <span class="token number">2</span> baseSequence: <span class="token parameter variable">-1</span> lastSequence: <span class="token parameter variable">-1</span> producerId: <span class="token parameter variable">-1</span> producerEpoch: <span class="token parameter variable">-1</span> partitionLeaderEpoch: <span class="token number">2</span> isTransactional: <span class="token boolean">false</span> isControl: <span class="token boolean">false</span> position: <span class="token number">701</span> CreateTime: <span class="token number">1614382712158</span> size: <span class="token number">159</span> magic: <span class="token number">2</span> compresscodec: NONE crc: <span class="token number">3726758683</span> isvalid: <span class="token boolean">true</span>
payload: <span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;TOPIC_RECORD&quot;</span>,<span class="token string">&quot;version&quot;</span>:0,<span class="token string">&quot;data&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;foo&quot;</span>,<span class="token string">&quot;topicId&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;5zoAlv-xEh9xRANKXt1Lbg&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
payload: <span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;PARTITION_RECORD&quot;</span>,<span class="token string">&quot;version&quot;</span>:0,<span class="token string">&quot;data&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;partitionId&quot;</span>:0,<span class="token string">&quot;topicId&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;5zoAlv-xEh9xRANKXt1Lbg&quot;</span>,<span class="token string">&quot;replicas&quot;</span>:<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>,<span class="token string">&quot;isr&quot;</span>:<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>,<span class="token string">&quot;removingReplicas&quot;</span>:null,<span class="token string">&quot;addingReplicas&quot;</span>:null,<span class="token string">&quot;leader&quot;</span>:1,<span class="token string">&quot;leaderEpoch&quot;</span>:0,<span class="token string">&quot;partitionEpoch&quot;</span>:0<span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-6-2-元数据shell"><a href="#_3-6-2-元数据shell" class="header-anchor">#</a> 3.6.2 元数据shell</h4> <p>另一个检查元数据日志的工具是<code>kafka-metadata-shell.sh</code>。就像ZooKeeper shell一样，可以检查集群的元数据。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>./bin/kafka-metadata-shell.sh  <span class="token parameter variable">--snapshot</span> /tmp/kraft-combined-logs/__cluster_metadata-0/00000000000000000000.log
</code></pre></div><p><img src="/LearingWord/assets/img/kafka-3-3-1-matadata.d046922d.png" alt="kafka-3-3-1-matadata.png"></p></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/LearingWord/tags/?tag=%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" title="标签">#消息队列</a></div> <!----></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/LearingWord/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/LearingWord/home.html"><div>
            项目相关
            <!----></div></a> <span class="date"></span></dt></dl><dl><dd>02</dd> <dt><a href="/LearingWord/high-performance/message-queue/consume-at-once/"><div>
            实现Kafka至少成功消费一次
            <!----></div></a> <span class="date">12-18</span></dt></dl><dl><dd>03</dd> <dt><a href="/LearingWord/database/redis/redis-big-key-question/"><div>
            Redis 大Key问题
            <!----></div></a> <span class="date">12-17</span></dt></dl> <dl><dd></dd> <dt><a href="/LearingWord/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:673052752@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://blog.csdn.net/qq_39410381?type=blog" title="csdn" target="_blank" class="iconfont icon-csdn"></a><a href="https://github.com/04sky" title="github" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/sikailin" title="gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> <!----></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/LearingWord/assets/js/app.385fc0f7.js" defer></script><script src="/LearingWord/assets/js/2.a91a21bc.js" defer></script><script src="/LearingWord/assets/js/3.6240dd65.js" defer></script>
  </body>
</html>
